<script>

var SPLIT = "$$|$||$||$|$||$|||$$$$|$|";

$(function () {
    appendHeaders();
    $("#selected, #baseList").sortable({connectWith: ".connectedSortable"}).disableSelection();
});

/**
 * Displays the given status message in the dialog.
 *
 * @param {String} msg The status message to display.
 * @param {String} classId The message type (class id) that the message
 *   should be displayed as.
 */
 //TODO error handling
function showStatus(msg, classId) {
	$('#dialog-status').removeClass().html(msg);
	if (classId) {
		$('#dialog-status').addClass(classId);
	}
}

function appendHeaders() {
	materialLoading(true);
	google.script.run
		.withSuccessHandler(
      function (msg, element) {
				for (var i = 0; i < msg.length; i++) {
          //TODO check sanitation
					$("#baseList").append('<li id="' + i + '"><span class="mdl-chip"><span class="mdl-chip__text">' + msg[i] + '</span></span></li>')
				}
				materialLoading(false);
			})
		.withFailureHandler(
			function (msg, element) {
				showStatus(msg, 'error');
				materialLoading(false);
			})
		.getHeaders();
}

function showSidebar() {
	google.script.run
		.withSuccessHandler(function () {
			google.script.host.close();
		})
		.showSidebar();
}

$("#submit").click(function () {
	materialLoading(true);
	$("#submit").prop("disabled", true)

	var output = [];
	$('#selected li').each(function (i) {
		output.push($(this).attr('id'))
	});

	google.script.run
		.withSuccessHandler(function () {
			google.script.run
        .withSuccessHandler(showSidebar)
				.withFailureHandler(function (e) {
          $("#submit").prop("disabled", false)
          materialLoading(false);
        })
        .createPrintables()
		})
		.withFailureHandler(function (e) {
			$("#submit").prop("disabled", false)
			materialLoading(false);
		})
		.setProp("printableColumns", output.join(SPLIT))
});

//make selected li max size 5
$("#selected").on("sortreceive", function (event, ui) {
	if ($("#selected li").length > 5) {
		$(ui.sender).sortable('cancel');
	}
});

</script>
